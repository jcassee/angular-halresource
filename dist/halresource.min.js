"use strict";angular.module("halresource",["netstatus"]),angular.module("halresource").factory("GenericResource",["Resource",function(e){function t(t,r,n){angular.bind(this,e)(t),this.mediaType=r,this.data=n}return t.prototype=Object.create(e.prototype,{constructor:{value:t},$getRequest:{value:function(){return{method:"get",url:this.$uri,headers:{Accept:this.mediaType}}}},$putRequest:{value:function(){return{method:"put",url:this.$uri,data:this.data,headers:{"Content-Type":this.mediaType}}}},$update:{value:function(e){return this.data=e,this}}}),t}]),angular.module("halresource").factory("HalContext",["$http","$log","$q","HalResource",function(e,t,r,n){function u(e,t){return new n(e,t)}function o(e){this.resourceFactory=e||u,this.resources={}}o.prototype=Object.create(Object.prototype,{constructor:{value:o},get:{value:function(e,t){var r=this.resources[e];return r||(r=this.resources[e]=(t||this.resourceFactory)(e,this)),r}},copy:{value:function(e){var t=this.get(e.$uri);return angular.copy(e,t),t.$profile=e.$profile,t}},load:{value:function(e){return e.$syncTime?r.when(e):this.httpGet(e)}},httpGet:{value:function(t){return e(t.$getRequest()).then(function(e){var r=t.$update(e.data);return this.markSynced(r,Date.now())}).then(function(){return t})}},httpPut:{value:function(t){return e(t.$putRequest()).then(function(){return this.markSynced(t,Date.now())}).then(function(){return t})}},httpDelete:{value:function(t){return e(t.$deleteRequest()).then(function(){return this.markSynced(t,null)}).then(function(){return t})}},httpPost:{value:function(t,r,n,u){return e(t.$postRequest(r,n,u))}},markSynced:{value:function(e,t){return e=angular.isArray(e)?e:[e],e.forEach(function(e){e.$syncTime=t}),r.when()}}})}]),angular.module("halresource").factory("HalResource",["$log","Resource",function(e,t){function r(e,n){var u=Object.create(r.prototype),o=null,i=Object.create(u,{$context:{value:n},$profile:{get:function(){return o},set:function(e){if(o){var t=angular.isArray(o)?o:[o];t.forEach(function(e){var t=a[e]||{};Object.keys(t).forEach(function(e){delete u[e]})})}if(e){var r=angular.isArray(e)?e:[e];r.forEach(function(e){var t=a[e]||{};Object.defineProperties(u,t)})}o=e}}});return i._links={self:{href:e}},angular.bind(i,t)(e),i}function n(e,t){var r=[];return Object.keys(e._embedded||[]).forEach(function(u){var a=e._embedded[u];o(a,function(e){r=r.concat(n(e,t))})}),r.push(u(e,t)),r}function u(e,t){var r=t.get(e._links.self.href),n=o((e._links||{}).profile||{},function(e){return e.href});return n&&(r.$profile=n),Object.keys(r).forEach(function(e){delete r[e]}),Object.keys(e).forEach(function(t){r[t]=e[t]}),r}function o(e,t,r){return angular.isDefined(e)?Array.isArray(e)?e.map(function(e){return angular.bind(r,t)(e)}):angular.bind(r,t)(e):void 0}var a={};return r.prototype=Object.create(t.prototype,{constructor:{value:r},$toState:{value:function(){var e=angular.extend({},this);return delete e._links,delete e._embedded,e}},$href:{value:function(t,r){var n=!1,u=!1,a={},i=o(this._links[t],function(e){"templated"in e&&(n=!0),"templated"in e||(u=!0),"deprecation"in e&&(a[e.deprecation]=!0);var t=e.href;return r&&(t=new UriTemplate(t).fillFromObject(r)),t},this),c=o((this._embedded||{})[t],function(e){return u=!0,e._links.self.href},this);n&&!r&&e.warn("Following templated link relation '"+t+"' without variables"),u&&r&&e.warn("Following non-templated link relation '"+t+"' with variables");var s=Object.keys(a);return s.length>0&&e.warn("Following deprecated link relation '"+t+"': "+s.join(", ")),c?i?(angular.isArray(i)||(i=[i]),angular.isArray(c)||(c=[c]),i.concat(c)):c:i}},$rel:{value:function(e,t){return o(this.$href(e,t),function(e){return this.$context.get(e)},this)}},$prop:{value:function(e){return o(this[e],function(e){return this.$context.get(e)},this)}},$getRequest:{value:function(){return{method:"get",url:this.$uri,data:this,headers:{Accept:"application/hal+json"}}}},$putRequest:{value:function(){return{method:"put",url:this.$uri,data:this.$toState(),headers:{"Content-Type":"application/json"}}}},$update:{value:function(e){var t=((e._links||{}).self||{}).href;if(t!=this.$uri)throw new Error("Self link href differs: expected '"+this.$uri+"', was '"+t+"'");return n(e,this.$context)}}}),Object.defineProperties(r,{registerProfile:{value:function(e,t){var r=angular.copy(t);angular.forEach(r,function(e){e.configurable=!0}),a[e]=r}},registerProfiles:{value:function(e){angular.forEach(e,function(e,t){r.registerProfile(t,e)})}}}),r}]),angular.module("halresource").factory("OfflineHalContext",["$http","$log","$q","$rootScope","HalContext","Netstatus",function(e,t,r,n,u,o){function a(){angular.bind(this,u)()}var i=new Dexie("offlinecache");i.version(1).stores({resources:"",requests:"++,[url+method]"}),i.on("error",function(e){t.error("ResourcheCache: "+e),n.$broadcast("offlinecache:error",e)}),i.on("blocked",function(){t.warn("ResourceCache: database is blocked"),n.$broadcast("offlinecache:blocked")}),i.open(),a.prototype=Object.create(u.prototype,{constructor:{value:a},httpGet:{value:function(e){return o.offline?i.resources.get(e.$uri).then(function(t){return e.$sync(t,!1)}):u.prototype.httpGet(e)}},httpPut:{value:function(e){return o.offline?i.transaction("rw",i.resources,i.requests,function(){i.requests.add(e.$putRequest()),i.resources.put(e,e.$uri)}).then(function(){return e}):u.prototype.httpPut(e)}},httpDelete:{value:function(e){return o.offline?i.transaction("rw",i.resources,i.requests,function(){i.requests.add(e.$deleteRequest()),i.resources["delete"](e.$uri)}).then(function(){return e}):u.prototype.httpDelete(e)}},httpPost:{value:function(e,t,r,n){return o.offline?i.requests.add(e.$postRequest(t,r,n)).then(function(){return e}):u.prototype.httpPost(e,t,r,n)}},markSynced:{value:function(e,t){return e=angular.isArray(e)?e:[e],i.transaction("rw",i.resources,function(){e.forEach(function(e){t?i.resources.put(e,e.$uri):i.resources["delete"](e.$uri)})}).then(function(){return u.prototype.markSynced(e)})}}})}]),angular.module("halresource").factory("Resource",[function(){function e(e){Object.defineProperties(this,{$uri:{value:e},$syncTime:{value:null,writable:!0}})}return e.prototype=Object.create(Object.prototype,{constructor:{value:e},$getRequest:{value:function(){throw new Error("Abstract method")}},$get:{value:function(){return this.$context.httpGet(this)}},$load:{value:function(){return this.$context.load(this)}},$putRequest:{value:function(){throw new Error("Abstract method")}},$put:{value:function(){return this.$context.httpPut(this)}},$deleteRequest:{value:function(){return{method:"delete",url:this.$uri}}},$delete:{value:function(){return this.$context.httpDelete(this)}},$postRequest:{value:function(e,t,r){return(r=r||angular.identity)({method:"post",url:this.$uri,data:e,headers:t||{}})}},$post:{value:function(e,t,r){return this.$context.httpPost(this,e,t,r)}},$update:{value:function(e){throw new Error("Abstract method")}}}),e}]);